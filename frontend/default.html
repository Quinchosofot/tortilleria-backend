<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>El Comal Digital</title>
    <style>
        /* Tus estilos originales */
        body { margin: 0; font-family: 'Segoe UI', sans-serif; background-color: #1e1e1e; color: #d4d4d4; display: flex; height: 100vh; }
        .cola { width: 50%; padding: 20px; box-sizing: border-box; border-right: 3px solid #333; display: flex; flex-direction: column; }
        table thead th { position: sticky; top: 0; background-color: #333; z-index: 2; }
        table { width: 100%; border-collapse: collapse; font-size: 1.2em; }
        th, td { padding: 10px; border: 1px solid #444; text-align: center; }
        th { background-color: #333; color: #fdd835; }
        tr:nth-child(even) { background-color: #2b2b2b; }
        .listo { background-color: #2e7d32; color: white; box-shadow: 0 0 10px 2px rgba(46, 125, 50, 0.8); }
        .promo { width: 50%; background-color: black; display: flex; align-items: center; justify-content: center; }
        video { max-width: 100%; max-height: 100%; }
        .slogan { margin-top: 5px; font-size: 1.1em; color: #ffa726; opacity: 0; transition: opacity 1s ease-in-out; }
    </style>
</head>
<body>

    <div style="position: absolute; top: 0; left: 0; width: 100%; background-color: #2c2c2c; padding: 10px 0; border-bottom: 2px solid #444; height: 150px;">
        <img src="comal-digital-logo.png" alt="Tu tortilleria Favorita" style="height: 100px; margin-left: 20px; float: left;">
        <div style="text-align: center; margin-top: 10px;">
            <h1 style="margin: 0; color: #fdd835; font-size: 2em;">Tu tortilleria favorita</h1>
            <p id="slogan" class="slogan">Cargando slogan...</p>
        </div>
    </div>

    <!-- Seccion para ingresar pedido -->
    <div class="cola" style="margin-top: 150px;">
        <div style="margin-bottom: 20px;">
            <input type="number" id="inputQuetzales" placeholder="Cantidad en Q" style="padding:10px; font-size:1rem; width: 150px;">
            <button onclick="crearPedido()" style="padding:10px 20px; font-size:1rem; cursor:pointer;">Crear Pedido</button>
        </div>

        <div id="scrollWrapper" class="scroll-content">
            <table id="tablaPedidos">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Orden</th>
                        <th>Total</th>
                        <th>Tortillas</th>
                        <th>Estado</th>
                        <th>Restante</th>
                       
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <!-- Video promocional -->
    <div class="promo">
        <video id="videoPromo" autoplay muted></video>
    </div>

    <script>
       const slogans = [
  "Calientitas, como deben ser",
  "Tradición que avanza",
  "Tecnología que sabe a casa",
  "Tus tortillas, en su punto y a tiempo",
  "Donde la tradición se encuentra con lo digital",
  "Ordena. Espera. ¡Disfruta!",
  "Tortillas con precisión digital",
  "Más que masa, es evolución",
  "¡Listo para servir, listo para ti!",
  "Lo bueno se cocina en tiempo real"
];
 let sloganIndex = 0;
        const sloganElement = document.getElementById("slogan");

        function mostrarSlogan() {
            sloganElement.style.opacity = 0;
            setTimeout(() => {
                sloganElement.textContent = slogans[sloganIndex];
                sloganElement.style.opacity = 1;
                sloganIndex = (sloganIndex + 1) % slogans.length;
            }, 1000);
        }

        mostrarSlogan();
        setInterval(mostrarSlogan, 4000);

        const tiempoPorTortilla = 4; // segundos
        const tortillasPorQuetzal = 4;
        let pedidos = [];
        let tortillasHechas = 0;
        let contadorPedidos = 1;

function imprimirTicket(pedido) {
    const fechaHora = new Date();
    const fechaStr = fechaHora.toLocaleDateString();
    const horaStr = fechaHora.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

    // Crear ventana nueva para imprimir
    const ventana = window.open('', 'Ticket', 'width=300,height=600');

    // Definir contenido del ticket
    ventana.document.write(`
        <html>
        <head>
            <title>Ticket de Pedido</title>
            <style>
                body { font-family: monospace; text-align: center; }
                .ticket {
                    width: 250px;
                    margin: auto;
                }
                .ticket h2 { margin: 10px 0; }
                .ticket p { margin: 5px 0; font-size: 14px; }
                hr { border: 1px dashed #000; margin: 10px 0; }
            </style>
        </head>
        <body onload="window.print(); window.close();">
            <div class="ticket">
                <h2>El Comal Digital</h2>
                <p>${fechaStr} ${horaStr}</p>
                <hr>
                <p><strong>${pedido.orden}</strong></p>
                <p><strong>Q${pedido.quetzales}.00</strong></p>
                <p>${pedido.tortillas} tortillas</p>
                <hr>
                <p>¡Gracias por su compra!</p>
            </div>
        </body>
        </html>
    `);

    ventana.document.close();
}

async function crearPedido() {
    const quetzalesInput = document.getElementById('inputQuetzales');
    const quetzales = parseInt(quetzalesInput.value);

    if (!quetzales || quetzales <= 0) {
        alert('Por favor ingresa una cantidad válida.');
        return;
    }

    try {
        const response = await fetch('https://tortilleria-backend.onrender.com/pedidos', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ cantidad: quetzales })
        });

        if (!response.ok) {
            const error = await response.json();
            alert('Error creando pedido: ' + (error.error || 'Desconocido'));
            return;
        }

        const nuevoPedido = await response.json();
        pedidos.push(nuevoPedido);
        quetzalesInput.value = '';
		quetzalesInput.focus(); // <-- Esto es lo nuevo
        mostrarPedidos();
		imprimirTicket();
    } catch (error) {
        console.error('Error conectando al servidor:', error);
        alert('Error de conexión con el backend.');
    }
}

        document.getElementById('inputQuetzales').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                crearPedido();
            }
        });

        function actualizarEntregas() {
            let disponibles = tortillasHechas;
            pedidos.forEach(pedido => {
                if (pedido.estado === "Listo para entrega") return;

                if (pedido.restante <= disponibles) {
                    disponibles -= pedido.restante;
                    pedido.restante = 0;
                    pedido.estado = "Listo para entrega";
                    pedido.entregaEstimada = new Date();
                } else if (pedido.restante > 0 && disponibles > 0) {
                    pedido.restante -= disponibles;
                    disponibles = 0;
                    pedido.estado = "En producción";
                }
            });
        }

        function mostrarPedidos() {
            const tbody = document.querySelector("#tablaPedidos tbody");
            tbody.innerHTML = "";

            pedidos.forEach(pedido => {
                const entregaStr = pedido.entregaEstimada
                    ? pedido.entregaEstimada.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' })
                    : "-";

                const row = `
                    <tr id="pedido-${pedido.id}" class="${pedido.estado === 'Listo para entrega' ? 'listo' : ''}">
                        <td>${pedido.id}</td>
                        <td>${pedido.orden}</td>
                        <td>Q${pedido.quetzales}</td>
                        <td>${pedido.tortillas}</td>
                        <td>${pedido.estado}</td>
                        <td>${pedido.restante}</td>
                      
                    </tr>
                `;

                tbody.innerHTML += row;
            });

            scrollAProximoListo();
        }

        function scrollAProximoListo() {
            const indexListo = pedidos.findIndex(p => p.estado === "Listo para entrega");
            if (indexListo === -1) return;

            const scrollIndex = Math.max(indexListo - 5, 0);
            const pedido = pedidos[scrollIndex];
            const rowElement = document.getElementById(`pedido-${pedido.id}`);
            if (rowElement) {
                rowElement.scrollIntoView({ behavior: "smooth", block: "start" });
            }
        }

        function producirTortilla() {
            tortillasHechas += 1;
            actualizarEntregas();
            mostrarPedidos();
        }

        setInterval(producirTortilla, tiempoPorTortilla * 1000);

        const videoList = ["video-tortillas.mp4"];
        let currentVideo = 0;
        const videoElement = document.getElementById("videoPromo");

        function playNextVideo() {
            videoElement.src = videoList[currentVideo];
            videoElement.play();
            currentVideo = (currentVideo + 1) % videoList.length;
        }

        videoElement.addEventListener("ended", playNextVideo);
        playNextVideo();
		// Poner foco inicial al cargar la página
window.onload = () => {
    document.getElementById('inputQuetzales').focus();
};
    </script>
</body>
</html>